# TLS (Thread Local Storage)

프로세스의 모든 쓰레드는 virtual address space를 공유한다. 함수의 로컬 변수는 함수를 실행시키는 각 쓰레드마다 unique하다. 하지만, static변수와 global 변수는 프로세스의 모든 쓰레드들이 공유한다. 그래서 TLS를 통해서, 각 쓰레드에 unique한 데이터를 제공할 수 있다. 그래서 프로세스는 global index를 사용하여 이 데이터에 접근할 수 있다. 하나의 쓰레드가 인덱스를 할당하면, 이 인덱스를 통해서 나머지 쓰레드도 index와 연관된 고유 데이터를 검색하는 데 사용할 수 있다.

상수 TLS_MINIMUM_AVAILABLE은 각 프로세스에서 사용가능한 TLS index의 최솟값을 정의한다. 이 값은 모든 시스템에서 적어도 64 이상이고, 최댓값은 1088이다.

쓰레드가 생성되면 시스템은 TLF를 위해 LPVOID라는 값의 배열을 할당한다. (이 배열은 NULL로 초기화된다.) 인덱스를 사용하려면 쓰레드 중 하나에 의해 인덱스가 할당되어야한다. 각 쓰레드는 각각의 데이터를 배열의 TLS index에 해당하는 TLS slot에 저장한다. 만약 데이터가 LPVOID value와 맞는 인텍스와 결합된다면, TLS slot에 직접 데이터를 저장할 수 있다. 그러나, 많은 인덱스를 사용하는 경우 별도의 저장 공간을 할당하고 데이터를 통합하며 사용중인 TLS slot 수를 최소화하는 것이 좋다.

아래 그림은 TLS가 어떻게 동작하는지를 잘 보여준다. 그림을 보면서 설명을 보도록 하자.

![tls](/image/TLS.png)

이 프로세스는 쓰레드1과 쓰레드2의 두 쓰레드를 가진다. 이들은 TLS의 두 인덱스들을 할당한다. (gdwTlsIndex1, gdwTlsIndex2) 각 쓰레드들은 데이터를 저장하는 두개의 메모리 블럭을 할당한다. TLS slot과 대응하는 메모리 블럭에 포인터값을 저장한다. index와 연관된 데이터에 접근하게 위해, 쓰레드는 TLS slot에서 메모리블럭에 대한 포인터를 찾고 IpvData 로컬 변수에 저장한다.
